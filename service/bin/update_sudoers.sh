#!/bin/bash
# Generate sudoers entries for all cPanel users found under /home
# Safely writes /etc/sudoers.d/varnish-cpanel-users after validation

set -euo pipefail

SUDOERS_FILE="/etc/sudoers.d/varnish-cpanel-users"
TMP_FILE="${SUDOERS_FILE}.tmp"
VARNISHCTL_PATHS=(
  "/opt/varnish-whm-manager/bin/varnishctl.sh"
  "/usr/local/varnish-whm-manager/bin/varnishctl.sh"
)

echo "# Auto-generated by update_sudoers.sh on $(date -u +%F\ %T) UTC" > "${TMP_FILE}"
echo "# Grants cPanel users permission to run varnishctl.sh without a password" >> "${TMP_FILE}"

# Enumerate user directories in /home and validate usernames exist
for dir in /home/*; do
  [[ -d "$dir" ]] || continue
  user="$(basename "$dir")"
  # Skip common non-user directories
  case "$user" in
    cpeasyapache|cpanel|virtual|virtfs|.cpan|.cpanm|.config|.cache|.ssh|backup|.softaculous)
      continue
      ;;
  esac
  id "$user" >/dev/null 2>&1 || continue
  for bin in "${VARNISHCTL_PATHS[@]}"; do
    echo "$user ALL=(ALL) NOPASSWD: $bin" >> "${TMP_FILE}"
  done
done

chmod 0440 "${TMP_FILE}"
# Validate before replacing
if visudo -c -f "${TMP_FILE}" >/dev/null 2>&1; then
  mv -f "${TMP_FILE}" "${SUDOERS_FILE}"
  echo "Updated sudoers: ${SUDOERS_FILE}"
else
  echo "Validation failed for ${TMP_FILE}; leaving existing sudoers unchanged" >&2
  exit 1
fi
